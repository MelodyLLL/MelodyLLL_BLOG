<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.63">
    <style>
      :root {
        --c-bg: #fff;
      }
      html.dark {
        --c-bg: #22272e;
      }
      html, body {
        background-color: var(--c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme');
			const systemDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
			if (userMode === 'dark' || (userMode !== 'light' && systemDarkMode)) {
				document.documentElement.classList.toggle('dark', true);
			}
    </script>
    <link rel="icon" href="/images/avator.webp"><title>Monorepo 前端组件库 | 改变 就是好事</title><meta name="description" content="Change is a good thing">
    <link rel="preload" href="/assets/style-28d80e86.css" as="style"><link rel="stylesheet" href="/assets/style-28d80e86.css">
    <link rel="modulepreload" href="/assets/app-abb8a49b.js"><link rel="modulepreload" href="/assets/Engineering4.html-479c447e.js"><link rel="modulepreload" href="/assets/Engineering4.html-8dd437bd.js"><link rel="prefetch" href="/assets/index.html-16be6a97.js" as="script"><link rel="prefetch" href="/assets/comment.html-a1933e7b.js" as="script"><link rel="prefetch" href="/assets/a-javascript.html-409ed318.js" as="script"><link rel="prefetch" href="/assets/b-html_css.html-fa1d1568.js" as="script"><link rel="prefetch" href="/assets/c-internet.html-01cbb3c8.js" as="script"><link rel="prefetch" href="/assets/d-vue.html-f56ec2d1.js" as="script"><link rel="prefetch" href="/assets/e-react.html-082f1c63.js" as="script"><link rel="prefetch" href="/assets/f-typescript.html-ae48ae46.js" as="script"><link rel="prefetch" href="/assets/f1-buildTools.html-e27cca49.js" as="script"><link rel="prefetch" href="/assets/f2-miniprogram.html-64e2fd99.js" as="script"><link rel="prefetch" href="/assets/g-nodejs.html-16ddac54.js" as="script"><link rel="prefetch" href="/assets/h-optimization.html-1d75efce.js" as="script"><link rel="prefetch" href="/assets/i-algorithm.html-ac5882d7.js" as="script"><link rel="prefetch" href="/assets/j-crossPlatform.html-3812db8a.js" as="script"><link rel="prefetch" href="/assets/k-designPatterns.html-cd418003.js" as="script"><link rel="prefetch" href="/assets/Engineering1.html-5699ad6e.js" as="script"><link rel="prefetch" href="/assets/Engineering2.html-0782de2e.js" as="script"><link rel="prefetch" href="/assets/Engineering3.html-0cb3416c.js" as="script"><link rel="prefetch" href="/assets/i18n-util.html-c3649088.js" as="script"><link rel="prefetch" href="/assets/vscode.html-1ab7ce48.js" as="script"><link rel="prefetch" href="/assets/svelte.html-8ee8bcbb.js" as="script"><link rel="prefetch" href="/assets/React1.html-d2e0cca8.js" as="script"><link rel="prefetch" href="/assets/Typescript1.html-6a514f46.js" as="script"><link rel="prefetch" href="/assets/404.html-f9875e7b.js" as="script"><link rel="prefetch" href="/assets/index.html-fd74edd9.js" as="script"><link rel="prefetch" href="/assets/comment.html-8a7289bd.js" as="script"><link rel="prefetch" href="/assets/a-javascript.html-f01701fa.js" as="script"><link rel="prefetch" href="/assets/b-html_css.html-6cb51224.js" as="script"><link rel="prefetch" href="/assets/c-internet.html-e572772c.js" as="script"><link rel="prefetch" href="/assets/d-vue.html-5430d022.js" as="script"><link rel="prefetch" href="/assets/e-react.html-0f27cd06.js" as="script"><link rel="prefetch" href="/assets/f-typescript.html-66442b77.js" as="script"><link rel="prefetch" href="/assets/f1-buildTools.html-02aaf918.js" as="script"><link rel="prefetch" href="/assets/f2-miniprogram.html-ba66ebf8.js" as="script"><link rel="prefetch" href="/assets/g-nodejs.html-e4c65801.js" as="script"><link rel="prefetch" href="/assets/h-optimization.html-5a0052a0.js" as="script"><link rel="prefetch" href="/assets/i-algorithm.html-455e6e32.js" as="script"><link rel="prefetch" href="/assets/j-crossPlatform.html-c7148783.js" as="script"><link rel="prefetch" href="/assets/k-designPatterns.html-5703c5e4.js" as="script"><link rel="prefetch" href="/assets/Engineering1.html-11dd7a31.js" as="script"><link rel="prefetch" href="/assets/Engineering2.html-2d863b04.js" as="script"><link rel="prefetch" href="/assets/Engineering3.html-19d6870d.js" as="script"><link rel="prefetch" href="/assets/i18n-util.html-48dd9544.js" as="script"><link rel="prefetch" href="/assets/vscode.html-d47de4dc.js" as="script"><link rel="prefetch" href="/assets/svelte.html-6446893d.js" as="script"><link rel="prefetch" href="/assets/React1.html-7880526f.js" as="script"><link rel="prefetch" href="/assets/Typescript1.html-01cbf4fe.js" as="script"><link rel="prefetch" href="/assets/404.html-2e347bc8.js" as="script"><link rel="prefetch" href="/assets/giscus-4b786244.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/" class=""><img class="logo" src="/images/avator.webp" alt="改变 就是好事"><span class="site-name can-hide">改变 就是好事</span></a></span><div class="navbar-items-wrapper" style=""><!--[--><!--]--><nav class="navbar-items can-hide"><!--[--><div class="navbar-item"><a href="/" class="" aria-label="首页"><!--[--><!--]--> 首页 <!--[--><!--]--></a></div><div class="navbar-item"><a href="/interview/a-javascript.md" class="" aria-label="面经"><!--[--><!--]--> 面经 <!--[--><!--]--></a></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="笔记"><span class="title">笔记</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="笔记"><span class="title">笔记</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/note/react/React1.md" class="" aria-label="React相关"><!--[--><!--]--> React相关 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/note/engineering/Engineering1.md" class="" aria-label="前端工程化"><!--[--><!--]--> 前端工程化 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/note/typescript/Typescript1.md" class="" aria-label="Typescript"><!--[--><!--]--> Typescript <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/note/new/svelte.md" class="" aria-label="技术前线"><!--[--><!--]--> 技术前线 <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><a href="/comment.md" class="" aria-label="留言"><!--[--><!--]--> 留言 <!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button class="toggle-color-mode-button" title="toggle color mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><form class="search-box" role="search"><input type="search" placeholder="S键聚焦" autocomplete="off" spellcheck="false" value><!----></form></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-items"><!--[--><div class="navbar-item"><a href="/" class="" aria-label="首页"><!--[--><!--]--> 首页 <!--[--><!--]--></a></div><div class="navbar-item"><a href="/interview/a-javascript.md" class="" aria-label="面经"><!--[--><!--]--> 面经 <!--[--><!--]--></a></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="笔记"><span class="title">笔记</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="笔记"><span class="title">笔记</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/note/react/React1.md" class="" aria-label="React相关"><!--[--><!--]--> React相关 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/note/engineering/Engineering1.md" class="" aria-label="前端工程化"><!--[--><!--]--> 前端工程化 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/note/typescript/Typescript1.md" class="" aria-label="Typescript"><!--[--><!--]--> Typescript <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/note/new/svelte.md" class="" aria-label="技术前线"><!--[--><!--]--> 技术前线 <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><a href="/comment.md" class="" aria-label="留言"><!--[--><!--]--> 留言 <!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-items"><!--[--><li><p tabindex="0" class="sidebar-item sidebar-heading active">前端工程化笔记 <!----></p><ul style="" class="sidebar-item-children"><!--[--><li><a href="/note/engineering/Engineering1.html" class="sidebar-item" aria-label="前端基建规范"><!--[--><!--]--> 前端基建规范 <!--[--><!--]--></a><!----></li><li><a href="/note/engineering/Engineering2.html" class="sidebar-item" aria-label="自定义eslint插件"><!--[--><!--]--> 自定义eslint插件 <!--[--><!--]--></a><!----></li><li><a href="/note/engineering/Engineering3.html" class="sidebar-item" aria-label="升级 webpack5"><!--[--><!--]--> 升级 webpack5 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/note/engineering/Engineering4.html" class="router-link-active router-link-exact-active router-link-active sidebar-item active" aria-label="Monorepo 前端组件库"><!--[--><!--]--> Monorepo 前端组件库 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/note/engineering/Engineering4.html#背景" class="router-link-active router-link-exact-active sidebar-item" aria-label="背景"><!--[--><!--]--> 背景 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/note/engineering/Engineering4.html#monorepo-是什么" class="router-link-active router-link-exact-active sidebar-item" aria-label="Monorepo 是什么？"><!--[--><!--]--> Monorepo 是什么？ <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/note/engineering/Engineering4.html#pnpm" class="router-link-active router-link-exact-active sidebar-item" aria-label="pnpm？"><!--[--><!--]--> pnpm？ <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/note/engineering/Engineering4.html#版本控制管理流程" class="router-link-active router-link-exact-active sidebar-item" aria-label="版本控制管理流程"><!--[--><!--]--> 版本控制管理流程 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/note/engineering/Engineering4.html#构建工具" class="router-link-active router-link-exact-active sidebar-item" aria-label="构建工具"><!--[--><!--]--> 构建工具 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/note/engineering/Engineering4.html#文档库" class="router-link-active router-link-exact-active sidebar-item" aria-label="文档库"><!--[--><!--]--> 文档库 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/note/engineering/Engineering4.html#本地调试" class="router-link-active router-link-exact-active sidebar-item" aria-label="本地调试"><!--[--><!--]--> 本地调试 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/note/engineering/Engineering4.html#总结" class="router-link-active router-link-exact-active sidebar-item" aria-label="总结"><!--[--><!--]--> 总结 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a href="/note/engineering/vscode.html" class="sidebar-item" aria-label="vscode 插件开发"><!--[--><!--]--> vscode 插件开发 <!--[--><!--]--></a><!----></li><li><a href="/note/engineering/i18n-util.html" class="sidebar-item" aria-label="自研i18n国际化工具"><!--[--><!--]--> 自研i18n国际化工具 <!--[--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><!--]--><div><h1 id="monorepo-前端组件库" tabindex="-1"><a class="header-anchor" href="#monorepo-前端组件库" aria-hidden="true">#</a> Monorepo 前端组件库</h1><h2 id="背景" tabindex="-1"><a class="header-anchor" href="#背景" aria-hidden="true">#</a> 背景</h2><p>公司一直有所谓组件库的实践，c 端有小程序端基于 taro 的，b 端也有 web 端的组件库。但是实际上，c 端的组件库就是上传了一些 taro 的源码到 npm，而且由于一些业务因素，写了一些兼容代码导致打包会将整个库打入。 而 b 端的组件库某种程度上说更进一步，因为至少有用 rollup 进行打包了，也就是说对体积、兼容性等至少做了一些优化。但是整个组件库工程依然看起来很零散。就比如，基本的 eslint 等工具也没有引入、开发组件的过程采用了类似 npm link 的方式来本地调试、没有一个简洁大方的 web 文档、没有统一的发版流程。因此我觉得，如果向开源组件库去学习的话，我们至少还缺少</p><ul><li>更合理规范的项目结构</li><li>更加友善的开发接入方式</li><li>更统一的发版流程</li><li>更接近开源库的打包产物质量</li><li>简洁大方的在线组件文档库</li></ul><p>基于这些原因，我开始想，是否也可以做一个靠近开源组件库的真正意义上的组件库？针对以上，我开始在网上搜索一些关于开源组件库的介绍和源码。也对于组件库这个东西有了更深层次的认识，其实组件库比我想象的复杂的多。</p><h2 id="monorepo-是什么" tabindex="-1"><a class="header-anchor" href="#monorepo-是什么" aria-hidden="true">#</a> Monorepo 是什么？</h2><p>Monorepo 是指在一个版本库（repository）中管理多个项目或应用程序的代码的软件开发方法。在前端领域，Monorepo 架构被广泛应用于管理多个相关的前端项目或库。</p><p>Monorepo 的发展历史，由单仓库巨石应用 ➡️ 多仓库多模块 ➡️ 单仓库多模块发展</p><img src="/images/monorepo4.png"><p style="text-align:center;">monorepo的发展，图片来源于互联网，侵删</p><p>Monorepo 架构通常具有以下特点：</p><ol><li><p><strong>单一版本库</strong>：所有相关的项目或库都存储在同一个版本库中，而不是分散在多个独立的版本库中。</p></li><li><p><strong>共享依赖</strong>：Monorepo 中的项目可以共享依赖，减少重复安装和管理依赖的工作，提高开发效率和代码复用性。</p></li><li><p><strong>统一构建和部署流程</strong>：所有项目都使用相同的构建和部署流程，可以更容易地管理和维护。</p></li><li><p><strong>共享配置</strong>：Monorepo 中的项目可以共享配置文件，如 ESLint、Prettier、Babel 等，确保所有项目保持一致的代码风格和规范。</p></li><li><p><strong>跨项目协作</strong>：开发团队可以更轻松地在不同项目之间共享代码、提交变更、进行协作，提高团队协作效率。</p></li><li><p><strong>版本控制</strong>：使用单一版本库可以更好地跟踪项目之间的依赖关系和变更历史，便于进行版本控制和管理。</p></li></ol><p>Monorepo 架构在前端开发中的应用越来越多，特别是对于大型项目或团队来说，它可以带来更好的代码管理、协作和维护体验。常见的 Monorepo 工具包括 Yarn Workspaces、Lerna、Nx 等。</p><p>monorepo 项目的结构看起来是这样的：</p><img src="/images/monorepo1.png" style="display:block;margin:0 auto;"><p style="text-align:center;">monorepo项目目录</p><p>上图可以看到，我们的一些项目，尤其是比如组件库项目，它或许不止一个仓库，它可能有配套的工具库、文档库、甚至一些测试、调试仓库。按之前的开发模式来的话，我们需要打开好几个窗口和 git 链接来查看这些仓库。同时要分别安装这些依赖，更重要的一点是，在一个组件的开发过程中，避免不了要经常调试，如果是分仓库开发，就不得不用到 npm link 手动处理这些(当然 npm link 是一个很不错的方式)，而且需要频繁在多个窗口之间切来切去。另外我，几乎你能说出名字的一些开源库，都采用了 monorepo 的形式来搭建项目，如 babel,react,vant 等。</p><h2 id="pnpm" tabindex="-1"><a class="header-anchor" href="#pnpm" aria-hidden="true">#</a> pnpm？</h2><p>项目结构已经确定，使用 monprepo 前还需要确定的一件事就是基础的包管理工具，我们对比了一下主流的几款</p><table><thead><tr><th>特性</th><th>npm</th><th>Yarn</th><th>pnpm</th></tr></thead><tbody><tr><td>安装速度</td><td>较慢</td><td>较快</td><td>非常快</td></tr><tr><td>离线安装支持</td><td>依赖 package-lock.json</td><td>依赖 yarn.lock</td><td>依赖 pnpm-lock.yaml</td></tr><tr><td>安装包并行性</td><td>不支持</td><td>支持</td><td>支持</td></tr><tr><td>安装包版本控制</td><td>package-lock.json</td><td>yarn.lock</td><td>pnpm-lock.yaml</td></tr><tr><td>monorepo</td><td>支持（需额外配置工具）</td><td>支持</td><td>支持</td></tr><tr><td>内置二进制缓存</td><td>不支持</td><td>支持</td><td>支持</td></tr><tr><td>安装后占用空间</td><td>中等</td><td>较大</td><td>较小</td></tr><tr><td>执行 npm 脚本</td><td>支持</td><td>支持</td><td>支持</td></tr><tr><td>活跃度和社区支持</td><td>非常活跃</td><td>较活跃</td><td>较活跃</td></tr><tr><td>适用场景</td><td>通用</td><td>通用</td><td>通用</td></tr></tbody></table><p>可以比较出来，使用 pnpm 目前来说是比较好的。而且其实个人有使用 yarn 搭建过 monorepo 项目，安装依赖后发现每个项目下的依赖项并不是很清晰，而且 yarn 的命令在 monorepo 实践中也略显混乱。另外，除了安装速度更快，磁盘空间占用更小，pnpm 采用软链接和硬链接的方式，还解决了 npm(&gt;v3 版本)和 yarn 扁平依赖结构带来的幽灵依赖、依赖分身等一些问题。</p><img src="/images/monorepo2.png" style="zoom:70%;display:block;margin:0 auto;"><p style="text-align:center;">幽灵依赖</p><img src="/images/monorepo3.png" style="zoom:57%;display:block;margin:0 auto;"><p style="text-align:center;">依赖分身</p><h2 id="版本控制管理流程" tabindex="-1"><a class="header-anchor" href="#版本控制管理流程" aria-hidden="true">#</a> 版本控制管理流程</h2><p>其实当你打开任何一个开源组件库的源码，都会发现它有一套复杂的自定义构建和发版流程，构建很容易理解，我们的组件库产物最终都要经过构建工具的一系列处理才能更加通用和优秀。但是这是不够的，丰富的组件库一般都是由多人协作而成，而组件库也不一成不变，而是比业务项目的更新更加频繁，如何保证组件库的通用和优秀，必然需要一套版本控制管理的流程。那如何做呢？</p><p>提到版本控制，我们必然会想到<a href="https://semver.org/lang/zh-CN/" target="_blank" rel="noopener noreferrer">语义化版本<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>，这算是已经解决我们一部分问题了，但是还远远不够，举一个例子，如果我们现在有两个组件库项目，一个工具库项目，如果他们之间还存在关联，是否发版的时候我们需要手动去修改三个项目的版本号？需要去打三个 tag？再举一个例子，开源的组件库项目中都会有组件库的 changelog，如果我们需要把这些展示在文档网站上，每次发版前该怎样处理？而这些在开源社区，已经有大佬为我们准备了现成的库，比如：changesets 和 lerna。</p><p>这里我们选择 lerna，为什么？因为 lerna 是一个足够“老牌”的 monorepo 管理工具，而且他的功能非常齐全，下面是它的一些功能点：</p><ul><li><p>版本管理：Lerna 可以帮助统一管理多个包的版本，确保它们之间的版本保持一致。当某个包的代码发生变化时，可以使用 Lerna 更新所有相关包的版本，并将更新的版本信息记录在一个共同的版本控制文件中（如 lerna.json 或 package.json）。</p></li><li><p>依赖管理：Lerna 可以帮助管理多个包之间的依赖关系。它可以自动解决包之间的依赖关系，并确保每个包都安装了正确的依赖版本。</p></li><li><p>发布流程：Lerna 提供了一套工具来简化发布流程，可以一次性发布多个包，也可以自动更新版本号并发布更新的包到 npm 或其他包管理器中。</p></li><li><p>代码维护：Lerna 提供了一些工具来简化代码维护过程，如自动化测试、代码提交、代码风格检查等。</p></li></ul><p>同时像生成更新日志这些功能也都具有，而且像依赖管理这些甚至和 pnpm 重叠了，相对来说，changesets 更加轻量化，不过每种工具最终的引用都是基于需求，如果有特定的需求，也可以二者结合使用。</p><p>那么使用 lerna 如何管理组件库版本？这里需要了解 Lerna 有两种模式：Fixed 和 Independent。</p><p><strong>在 Fixed 模式下，所有的包都会使用统一的版本号，版本号由 Lerna 控制。 当有一个包发生变更并准备发布时，Lerna 会为所有的包自动增加相同的版本号，并发布更新后的包。</strong></p><p><strong>在 Independent 模式下，每个包都有自己独立的版本号，版本号由开发人员手动管理。 当一个包发生变更并准备发布时，开发人员需要手动指定要发布的包以及它们的新版本号。</strong></p><p>看个人的需求，这里我们选用独立模式。这也是开源项目都比较常用的一种。使用 lerna 非常简单，两行命令即可</p><p>选择你所需要发布的版本</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>lerna version --no-private
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>你将会得到下面的输出</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>lerna notice cli v5.1.2
lerna info current version <span class="token number">1.0</span>.0
lerna info Assuming all packages changed
? Select a new version <span class="token punctuation">(</span>currently <span class="token number">1.0</span>.0<span class="token punctuation">)</span> <span class="token punctuation">(</span>Use arrow keys<span class="token punctuation">)</span>
❯ Patch <span class="token punctuation">(</span><span class="token number">1.0</span>.1<span class="token punctuation">)</span>
  Minor <span class="token punctuation">(</span><span class="token number">1.1</span>.0<span class="token punctuation">)</span>
  Major <span class="token punctuation">(</span><span class="token number">2.0</span>.0<span class="token punctuation">)</span>
  Prepatch <span class="token punctuation">(</span><span class="token number">1.0</span>.1-alpha.0<span class="token punctuation">)</span>
  Preminor <span class="token punctuation">(</span><span class="token number">1.1</span>.0-alpha.0<span class="token punctuation">)</span>
  Premajor <span class="token punctuation">(</span><span class="token number">2.0</span>.0-alpha.0<span class="token punctuation">)</span>
  Custom Prerelease
  Custom Version
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>接着，发布！</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>lerna publish --no-private
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>可以看到 footer 和 header 两个项目已经发版成功</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>lerna notice cli v5.1.2
lerna info current version <span class="token number">1.0</span>.0
lerna info Assuming all packages changed
? Select a new version <span class="token punctuation">(</span>currently <span class="token number">1.0</span>.0<span class="token punctuation">)</span> Patch <span class="token punctuation">(</span><span class="token number">1.0</span>.1<span class="token punctuation">)</span>

Changes:
 - footer: <span class="token number">1.0</span>.0 <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">1.0</span>.1
 - header: <span class="token number">1.0</span>.0 <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">1.0</span>.1

? Are you sure you want to publish these packages? Yes
lerna info execute Skipping releases
lerna info <span class="token function">git</span> Pushing tags<span class="token punctuation">..</span>.
lerna info publish Publishing packages to npm<span class="token punctuation">..</span>.
<span class="token punctuation">..</span>.
lerna success published header <span class="token number">1.0</span>.1
<span class="token punctuation">..</span>.
lerna success published footer <span class="token number">1.0</span>.1
<span class="token punctuation">..</span>.
Successfully published:
 - footer@1.0.1
 - header@1.0.1
lerna success published <span class="token number">2</span> packages
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>当然，实际使用上还是会有一些学习成本，比如它的一些命令参数和一些小坑。比如我们可以学习到加入 lerna version 后面加入--conventional-commits 命令即可以生产 changelog.md 文件！</p><h2 id="构建工具" tabindex="-1"><a class="header-anchor" href="#构建工具" aria-hidden="true">#</a> 构建工具</h2><p>构建工具是组件库必不可少也是最重要的一个组成，因为它是输出一个优质的组件库产物的始作俑者，按照我的想法，我们的组件库应该需要有一个 web 端的组件库，一个工具包，这样我们至少需要两类构建工具，一个用输出我们的工具类，一个用来输出我们的组件。 关于工具库的话，没有什么太多的可比性，配置简洁、输出 es 模块的直接选择 rollup 即可，简直是为打包工具类量身定制的类库。</p><p>关于组件库打包的方式就多种多样了，你或许会想到 webpack、rollup 这些，但是大部分开源库在这个上面基本不会说单独用到一个工具，而是使用多个，如 webpack+glup，因为一个足够优秀的组件库单靠一个构建工具是不够的。</p><p>这里我们简化一下，不需要一开始就做的很复杂，这里我首先排除了 webpack，因为我觉得它的配置是最多的，当然功能够强大，但是我们实际上只需要它打包的功能，另外我有想到 esbuild，这个现代化的打包工具打包速度极快，可以用 async 函数来编写它的配置，让人一目了然。不过因为它的产物只能是 es6 或者更高版本的 js 模块，这样兼容性就不够好了。那么实际上我就只有 rollup 可选了，但是我最终选择了 vite，因为它的构建就是基于 rollup，而且它的开箱即用让我不需要配置任何东西。实在是太方便了。</p><h2 id="文档库" tabindex="-1"><a class="header-anchor" href="#文档库" aria-hidden="true">#</a> 文档库</h2><p>前端的组件库文档系统是指为前端开发团队提供的一种文档化工具，用于展示和说明组件库中的各种组件、样式、用法和 API。它的目的是帮助开发人员快速了解和使用组件库，提高开发效率，保持一致的设计和用户体验。不止是组件库，任何比较有名的开源类库都会有自己的文档官网，用于开发者接入和彰显自己的影响力！下面是我最喜欢的开源库官网页面：</p><img src="/images/monorepo5.png" style="zoom:22%;display:block;margin:0 auto;"><p style="text-align:center;">rollup官网主页</p><p>在不同端（如 Web、移动端）中，前端组件库文档系统可以有不同的实现方式，如移动端的组件库文档就比较复杂一些，需要嵌入移动设备以让开发者能够“所见即所得”，如 taro、vant 这样的组件库官网。而组件库的实现也是百花齐放，因为开源社区也早有各种成熟的类库提供给我们：</p><p><strong>1. VuePress</strong>：适用 Vue.js，VuePress 是一个基于 Vue.js 的静态网站生成器，适用于构建文档网站。它提供了简洁易用的 Markdown 语法，支持自动生成侧边栏、导航栏、搜索功能等，非常适合用于构建前端组件库文档系统。</p><p><strong>2. Docusaurus</strong>：适用框架 React，Docusaurus 是由 Facebook 开发的静态网站生成器，适用于构建文档和博客网站。它具有简单易用的特点，支持自动生成导航、搜索、版本管理等功能，适合用于构建大型组件库文档系统。</p><p><strong>3. Storybook</strong>：适用框架 React、Vue.js、Angular 等多个框架，Storybook 是一个组件驱动的开发环境，用于开发、测试和文档化组件。它可以在独立的开发环境中展示组件的外观和交互，支持快速开发和测试，同时也可以生成组件的文档页面。</p><p><strong>4. Docz</strong>：适用框架 React，Docz 是一个基于 Gatsby 的文档生成器，适用于构建组件库文档。它支持使用 Markdown 和 JSX 编写文档，可以生成漂亮的文档网站，并提供了实时编辑和预览功能。</p><p><strong>5. 自研文档系统</strong>：不限 UI 框架，可定制，一些公司或项目团队会自行开发文档系统，如 taro，根据具体需求和项目特点进行定制。自研文档系统可以完全根据团队需要进行定制化开发，但也需要投入较大的开发资源。</p><p>以上列举的组件库文档解决方案都各有特点，可以根据具体项目需求、团队技术栈和规模来选择适合的方案。</p><p>由于我司使用的仍然是 vue2，而且我暂时并不想在文档库上投入太多精力，因为文档库必然使用 markdown 编写是最推荐的方式，而且需要提供组件的交互，这就必然需要基于 markdown 做组件的解析，开发成本是比较大的。另外像 storybook 这样的老牌组件文档搭建类库，看上去并不美观(个人观点)，定制化也没有那么自由，因此最终决定选用 vuepress，实际上 vuepress2 会更加的丰富和好看，但是由于我司的技术栈，因此只能选择 vuepress1.x。</p><h2 id="本地调试" tabindex="-1"><a class="header-anchor" href="#本地调试" aria-hidden="true">#</a> 本地调试</h2><p>不知道是否大家还记得这张图</p><img src="/images/monorepo1.png" style="display:block;margin:0 auto;"><p>介绍下这几个项目的作用</p><ul><li><strong>docs:</strong> 文档库项目由 vuepress1.x 搭建</li><li><strong>demo:</strong> 本地启动调试项目由 vite 搭建</li><li><strong>utils:</strong> 工具库项目由 rollup 构建</li><li><strong>webui:</strong> 组件库项目 由 vite 构建</li><li><strong>miniso-iscm-components:</strong> 同事后来添加的更具个性化的业务组件库，构建配置与 webui 一致</li></ul><p>在这里 monorepo 的架构就开始发挥它的作用了，我们使用 pnpm 的 workspace 特性来进行多包的管理。只需要新建下面的 pnpm-workspace.yaml 文件，pnpm 即可识别你的多包目录。</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">packages</span><span class="token punctuation">:</span>
  <span class="token comment"># 所有在 packages/ 子目录下的 package</span>
  <span class="token punctuation">-</span> <span class="token string">&#39;packages/**&#39;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>另外，譬如调试项目依赖组件库和工具库，我们只需要在调试项目的 package.json 中写入，这样就会自动引入最新的产物。</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token property">&quot;dependencies&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;@miniso/web-utils&quot;</span><span class="token operator">:</span> <span class="token string">&quot;workspace:*&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;@miniso/webui&quot;</span><span class="token operator">:</span> <span class="token string">&quot;workspace:*&quot;</span><span class="token punctuation">,</span>
    .....
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>我这边在本地调试项目的 main.js 中，利用 vite 的环境变量进行了判断，如果是 dev 命令启动，则直接调用组件库等项目的源码，这样可以达到热更新的效果。同时在组件库项目下修改我们的组件，也不需要复制来复制去了。</p><p>更重要的是，我们只需要安装一次依赖，pnpm i 则可以给我们所有项目进行依赖安装。</p><p>同时，我们将公共依赖和配置提升到项目顶层，比如 eslint 中，利用 overrides 属性管理多个类型的文件校验，还有 prettier 和 commitlint 等等公共配置由五份变成一份。另外由于 lerna 的命令较多而且与 pnpm 会产生重叠，我们把所有比如上文提到的发包等命令都交给 pnpm 来控制。</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>  <span class="token property">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;prepare&quot;</span><span class="token operator">:</span> <span class="token string">&quot;husky install&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;commitlint&quot;</span><span class="token operator">:</span> <span class="token string">&quot;lint-staged --allow-empty&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;build:comp&quot;</span><span class="token operator">:</span> <span class="token string">&quot;pnpm -F @miniso/webui build&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;build:iscm-comp&quot;</span><span class="token operator">:</span> <span class="token string">&quot;pnpm -F @miniso/iscm-components build&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;test&quot;</span><span class="token operator">:</span> <span class="token string">&quot;pnpm -F @miniso/demo-vue2 test&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;build:demo&quot;</span><span class="token operator">:</span> <span class="token string">&quot;pnpm -F @miniso/demo-vue2 build&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;dev&quot;</span><span class="token operator">:</span> <span class="token string">&quot;pnpm -F @miniso/demo-vue2 dev&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;dev:docs&quot;</span><span class="token operator">:</span> <span class="token string">&quot;pnpm -F @miniso/web-docs dev&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;build:docs&quot;</span><span class="token operator">:</span> <span class="token string">&quot;pnpm -F @miniso/web-docs build&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;build:utils&quot;</span><span class="token operator">:</span> <span class="token string">&quot;pnpm -F @miniso/web-utils build&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;clean&quot;</span><span class="token operator">:</span> <span class="token string">&quot;rimraf node_modules **/*/node_modules pnpm-lock.yaml&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;upload&quot;</span><span class="token operator">:</span> <span class="token string">&quot;npx lerna publish from-git&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;preupload&quot;</span><span class="token operator">:</span> <span class="token string">&quot;node ./build/prepublish.js&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;changelog&quot;</span><span class="token operator">:</span> <span class="token string">&quot;node ./build/movelog&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>并且加入自定义脚本提供发版前的交互式操作，进一步统一发版流程。</p><img src="/images/monorepo6.png" style="zoom:55%;display:block;margin:0 auto;"><h2 id="总结" tabindex="-1"><a class="header-anchor" href="#总结" aria-hidden="true">#</a> 总结</h2><p>目前来看，我们似乎已经做了很多事情，让整个项目变得非常的完善了。我们可以打包工具库和组件库，并且可以进行发布了。但是，这距离那些优秀的开源组件库，或者说一个完备的公司内部组件库也还是远远不够的。你是否会想到下面这些问题？</p><ul><li>组件库依赖了工具库如何处理发版？</li><li>组件 UI 样式如何统一？</li><li>组件兼容性？</li><li>是否需要加入 polyfill？</li><li>依赖三方库如何处理？</li><li>api 类型提示？</li><li>如何保证开发环境一致性？</li><li>如何像开源库一样有更新日志？</li><li>是否可以按需自动引入样式？</li><li>是否按需加载？</li><li>如何为编写文档和示例？</li><li>是否有单元测试？</li><li>......</li></ul><p>拿第一个问题举例，一开始是直接在组件库的 dependencies 声明工具库依赖，这样会导致的问题是，每次工具库发版都会让组件库的版本也往上提升，这似乎是 lerna 的机制，但是看起来也是合理的。另外的问题是让组件库与工具库的耦合也更加紧密了。这里最终决定把工具库的依赖放到组件库的 peerDependencies 中，这样把库的安装与否交给用户。</p><p>当然我们已经解决了部分的问题，譬如加入 typescript 和.d.ts 声明文件完善类型提示，加入了 volta 保证 pnpm 与 node 的版本统一等。</p><p>之前有同事问我，组件库不就是复用代码么？我听完只是笑着点点头，当然这是一个非常重要的功能，但是却远远不止，并且要保证这个功能的可持续性所花的功夫是很大的，并不仅仅是 npm publish。到这里，是否对组件库的认识深一层了呢？实在是很佩服那些我们每天都在无偿使用的组件库的维护者。</p><h4 id="salute-to-element-ui、antd-ui、vant-ui-and-so-on" tabindex="-1"><a class="header-anchor" href="#salute-to-element-ui、antd-ui、vant-ui-and-so-on" aria-hidden="true">#</a> Salute to Element UI、Antd UI、Vant UI and so on!</h4></div><!--[--><!--]--></div><footer class="page-meta"><!----><div class="meta-item last-updated"><span class="meta-item-label">最后修改时间: </span><!----></div><div class="meta-item contributors"><span class="meta-item-label">编写者: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: d_o_double_g@163.com">MelodyLLL</span><!----><!--]--><!--]--></span></div></footer><nav class="page-nav"><p class="inner"><span class="prev"><a href="/note/engineering/Engineering3.html" class="" aria-label="升级 webpack5"><!--[--><!--]--> 升级 webpack5 <!--[--><!--]--></a></span><span class="next"><a href="/note/engineering/vscode.html" class="" aria-label="vscode 插件开发"><!--[--><!--]--> vscode 插件开发 <!--[--><!--]--></a></span></p></nav><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script type="module" src="/assets/app-abb8a49b.js" defer></script>
  </body>
</html>
